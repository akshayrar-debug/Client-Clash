<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Clash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .game-board {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .kpi-list-item {
            background-color: #374151;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 relative">

    <!-- Independent Timer -->
    <div id="timer-container" class="absolute top-4 right-4 game-board p-4 rounded-2xl shadow-lg flex items-center space-x-4 z-10">
        <div id="timer-display" class="text-5xl text-red-500 font-black">60</div>
        <div class="flex flex-col space-y-2">
            <button id="timer-start-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Start</button>
            <button id="timer-stop-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-1 px-3 rounded-md text-sm">Stop</button>
            <button id="timer-reset-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-sm">Reset</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6 pt-4">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Client Clash</h1>
            <p class="text-gray-400 mt-2">The Ultimate Game for CS and PM Professionals</p>
        </header>

        <!-- Main Content -->
        <main id="game-container">
            <!-- Main Menu Page -->
            <div id="main-menu-page" class="page active">
                <div class="game-board p-6 rounded-2xl shadow-2xl text-center">
                    <h2 class="text-3xl font-bold mb-6">Choose a Game</h2>
                    <div id="message-area" class="my-4 h-6 font-semibold"></div>
                    <div id="loading-state" class="hidden my-4">
                        <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-lg text-gray-300">AI is generating your game... Please wait.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center">
                        <button data-round="1" class="navigate-btn btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">EMEA Feud</button>
                        <button data-round="3" class="navigate-btn btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">KPI Identifier</button>
                        <button data-round="2" class="navigate-btn btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">Rapid Fire</button>
                    </div>
                </div>
            </div>

            <!-- Game Page -->
            <div id="game-page" class="page">
                 <div id="game-content-wrapper" class="game-board p-6 rounded-2xl shadow-2xl">
                    <!-- Game Content (Dynamically populated) -->
                    <div id="game-content"></div>
                     <div class="text-center mt-6">
                        <button id="back-to-menu-btn" class="btn bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg">Back to Menu</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const pages = {
                mainMenu: document.getElementById('main-menu-page'),
                game: document.getElementById('game-page'),
            };
            const gameContent = document.getElementById('game-content');
            const loadingState = document.getElementById('loading-state');
            const messageArea = document.getElementById('message-area');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            const timerDisplay = document.getElementById('timer-display');
            const timerStartBtn = document.getElementById('timer-start-btn');
            const timerStopBtn = document.getElementById('timer-stop-btn');
            const timerResetBtn = document.getElementById('timer-reset-btn');

            // --- GAME STATE ---
            let gameState = {
                gameData: null,
                currentRound: 0,
            };
            let timerInterval;
            let timeLeft = 60;

            // --- NAVIGATION ---
            function showPage(pageName) {
                Object.values(pages).forEach(page => page.classList.remove('active'));
                pages[pageName].classList.add('active');
            }

            document.querySelectorAll('.navigate-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const round = parseInt(e.currentTarget.dataset.round);
                    loadingState.classList.remove('hidden');
                    
                    try {
                        const gameData = await generateGameContent(round);
                        if (!gameData) throw new Error("AI failed to generate game data.");
                        
                        gameState.gameData = gameData;
                        gameState.currentRound = round;
                        
                        renderGame();
                        showPage('game');
                    } catch (error) {
                        console.error("Error starting game:", error);
                        showMessage("Failed to start game. Please try again.", true);
                    } finally {
                        loadingState.classList.add('hidden');
                    }
                });
            });

            backToMenuBtn.addEventListener('click', () => {
                showPage('mainMenu');
            });

            // --- TIMER LOGIC ---
            function startTimer() {
                clearInterval(timerInterval); // Prevent multiple intervals
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function resetTimer() {
                clearInterval(timerInterval);
                timeLeft = 60;
                timerDisplay.textContent = timeLeft;
            }

            timerStartBtn.addEventListener('click', startTimer);
            timerStopBtn.addEventListener('click', stopTimer);
            timerResetBtn.addEventListener('click', resetTimer);

            // --- GAME LOGIC ---
            function renderGame() {
                switch (gameState.currentRound) {
                    case 1: renderFamilyFeud(); break;
                    case 2: renderRapidFire(); break;
                    case 3: renderKPIIdentifier(); break;
                }
            }

            async function refreshFamilyFeud() {
                const refreshBtn = document.getElementById('refresh-feud-btn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                
                try {
                    const gameData = await generateGameContent(1);
                    gameState.gameData = gameData;
                    renderFamilyFeud();
                } catch (error) {
                     showMessage("Failed to refresh case.", true);
                     refreshBtn.disabled = false;
                     refreshBtn.textContent = 'Refresh Case';
                }
            }

            function renderFamilyFeud() {
                const roundData = gameState.gameData.familyFeud;
                let questionsHTML = roundData.questions.map((item, index) => `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="font-bold text-lg">${item.q}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <p id="feud-answer-${index}" class="text-green-400 blur-sm transition-all flex-grow text-left">${item.a}</p>
                            <button data-target="feud-answer-${index}" class="show-answer-btn btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show Answer</button>
                        </div>
                    </div>
                `).join('');

                gameContent.innerHTML = `
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <h2 class="text-3xl font-bold">EMEA Feud Case Study</h2>
                        <button id="refresh-feud-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Refresh Case</button>
                    </div>
                    <p class="text-lg text-gray-300 mb-6 bg-gray-900 p-4 rounded-lg">${roundData.case}</p>
                    <div class="space-y-4">${questionsHTML}</div>`;
                
                document.getElementById('refresh-feud-btn').addEventListener('click', refreshFamilyFeud);
                document.querySelectorAll('.show-answer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.target;
                        document.getElementById(targetId).classList.remove('blur-sm');
                        e.currentTarget.style.display = 'none';
                    });
                });
            }

            function renderRapidFire() {
                const roundData = gameState.gameData.rapidFire;
                let questionsHTML = roundData.map(item => `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="font-bold text-lg">${item.question}</p>
                        <p class="text-green-400 blur-sm hover:blur-none transition-all cursor-pointer">${item.answer}</p>
                    </div>
                `).join('');

                gameContent.innerHTML = `
                    <h2 class="text-3xl font-bold text-center mb-6">Rapid Fire Questions</h2>
                    <div class="space-y-4">${questionsHTML}</div>`;
            }

            async function refreshKPIs() {
                const refreshBtn = document.getElementById('refresh-kpi-btn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                
                try {
                    const gameData = await generateGameContent(3);
                    gameState.gameData = gameData;
                    renderKPIIdentifier();
                } catch (error) {
                     showMessage("Failed to refresh role.", true);
                     refreshBtn.disabled = false;
                     refreshBtn.textContent = 'Refresh Role';
                }
            }

            function renderKPIIdentifier() {
                const roundData = gameState.gameData.kpiIdentifier;
                const kpiListHTML = roundData.kpis.map(kpi => `<li class="kpi-list-item">${kpi}</li>`).join('');

                gameContent.innerHTML = `
                    <div class="text-center">
                        <div class="flex justify-center items-center gap-4 mb-2">
                            <h2 class="text-3xl font-bold">Whatfix Champion Persona</h2>
                            <button id="refresh-kpi-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Refresh Role</button>
                        </div>
                        <h3 class="text-4xl font-bold text-yellow-300 mb-4">${roundData.role}</h3>
                        <p class="text-lg text-gray-300 max-w-4xl mx-auto mb-8">${roundData.description}</p>
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <h4 class="text-2xl font-bold">Potential KPIs</h4>
                            <button id="show-kpis-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show KPIs</button>
                        </div>
                        <ul id="kpi-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center blur-md transition-all">${kpiListHTML}</ul>
                    </div>`;

                document.getElementById('refresh-kpi-btn').addEventListener('click', refreshKPIs);
                document.getElementById('show-kpis-btn').addEventListener('click', (e) => {
                    document.getElementById('kpi-list').classList.remove('blur-md');
                    e.currentTarget.style.display = 'none';
                });
            }

            function showMessage(message, isError = false) {
                messageArea.textContent = message;
                messageArea.className = isError ? 'text-red-500 my-4 h-6 font-semibold' : 'text-yellow-300 my-4 h-6 font-semibold';
                setTimeout(() => { messageArea.textContent = ''; }, 4000);
            }

            // --- AI CONTENT GENERATION ---
            async function generateGameContent(round) {
                let prompt;
                if (round === 1) {
                    prompt = `You are a sales strategy expert for Whatfix, focusing on the EMEA market. Create a short, one-paragraph case study about a potential enterprise client in the EMEA region facing digital transformation challenges. Based on this case, provide 5 "pure signal" questions a sales rep should ask to uncover pain points. Each question should have a concise, ideal answer. Return ONLY a valid JSON object like this: {"familyFeud": {"case": "...", "questions": [{"q": "...", "a": "..."}]}}`;
                } else if (round === 2) {
                    prompt = `Generate 5 'Rapid Fire' questions and answers for Customer Success and Project Managers. The tone should be professional but fun. Return ONLY a valid JSON object like this: {"rapidFire": [{"question": "...", "answer": "..."}, {"question": "...", "answer": "..."}]}`;
                } else if (round === 3) {
                    prompt = `You are an expert on the value proposition of Whatfix. Identify a key "Whatfix champion or sponsor role" within a potential enterprise client (e.g., Head of L&D, VP of Sales Ops, CIO). Provide the role title, a one-paragraph description of their challenges and goals relevant to Whatfix, and a list of 6 potential KPIs Whatfix can improve for them. Return ONLY a valid JSON object like this: {"kpiIdentifier": {"role": "...", "description": "...", "kpis": ["...", "..."]}}`;
                }

                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json" } };
                const apiKey = "AIzaSyABBoGL4O2Equv-1bhG-_9YArhhyv2cBA4"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    console.log("Gemini API Response:", parsedJson);
                    return parsedJson;
                } catch (error) {
                    console.error("AI content generation failed:", error);
                    showMessage("Could not connect to AI. Please check the API key and network.", true);
                    throw error; // Re-throw the error to be caught by the caller
                }
            }
        });
    </script>
</body>
</html>
