<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2 fast 2 curious</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
            padding-top: 120px; /* Increased space for the fixed scoreboard and timer */
        }
        .game-board {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .kpi-list-item {
            background-color: #374151;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .team-name-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            width: 120px;
        }
        .team-card.active {
             box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
             border-color: #3b82f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 relative">
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="modal-text" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Yes</button>
                <button id="modal-cancel-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scoreboard Bar -->
    <div id="scoreboard-bar" class="absolute top-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 p-4 z-20">
        <div class="w-full max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                 <button id="home-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-md" title="Back to Main Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                </button>
                <div id="teams-container" class="flex items-center gap-4"></div>
                <button id="add-team-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Add Team</button>
            </div>
            <button id="new-game-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm">New Game</button>
        </div>
    </div>

    <!-- Independent Timer -->
    <div id="timer-container" class="absolute top-24 right-4 game-board p-4 rounded-2xl shadow-lg flex items-center space-x-4 z-10">
        <div id="timer-display" class="text-5xl text-red-500 font-black">60</div>
        <div class="flex flex-col space-y-2">
            <button id="timer-start-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Start</button>
            <button id="timer-stop-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-1 px-3 rounded-md text-sm">Stop</button>
            <button id="timer-reset-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-sm">Reset</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6 pt-4">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">2 fast 2 curious</h1>
        </header>

        <!-- Main Content -->
        <main id="game-container">
            <!-- Main Menu Page -->
            <div id="main-menu-page" class="page active">
                <div class="game-board p-6 rounded-2xl shadow-2xl text-center">
                    <h2 class="text-3xl font-bold mb-6">Choose a Game</h2>
                    <div id="message-area" class="my-4 h-6 font-semibold"></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center">
                        <button data-round="1" class="navigate-btn btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">EMEA Feud</button>
                        <button data-round="3" class="navigate-btn btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">KPI Identifier</button>
                        <button data-round="2" class="navigate-btn btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">Fastest Finger First</button>
                    </div>
                </div>
            </div>

            <!-- Instructions Page -->
            <div id="instructions-page" class="page">
                <div class="game-board p-6 rounded-2xl shadow-2xl text-center">
                    <h2 id="instructions-title" class="text-3xl font-bold mb-4"></h2>
                    <div id="instructions-text" class="text-lg text-left text-gray-300 max-w-3xl mx-auto mb-6 space-y-2"></div>
                    <button id="start-game-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">Start Game</button>
                </div>
            </div>

            <!-- Game Page -->
            <div id="game-page" class="page">
                 <div id="game-content-wrapper" class="game-board p-6 rounded-2xl shadow-2xl">
                    <!-- Game Content (Dynamically populated) -->
                    <div id="game-content"></div>
                     <div class="text-center mt-6">
                        <button id="back-to-menu-btn" class="btn bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg">Back to Menu</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const pages = {
                mainMenu: document.getElementById('main-menu-page'),
                instructions: document.getElementById('instructions-page'),
                game: document.getElementById('game-page'),
            };
            const homeBtn = document.getElementById('home-btn');
            const gameContent = document.getElementById('game-content');
            const messageArea = document.getElementById('message-area');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            const timerDisplay = document.getElementById('timer-display');
            const timerStartBtn = document.getElementById('timer-start-btn');
            const timerStopBtn = document.getElementById('timer-stop-btn');
            const timerResetBtn = document.getElementById('timer-reset-btn');
            const teamsContainer = document.getElementById('teams-container');
            const addTeamBtn = document.getElementById('add-team-btn');
            const newGameBtn = document.getElementById('new-game-btn');
            const instructionsTitle = document.getElementById('instructions-title');
            const instructionsText = document.getElementById('instructions-text');
            const startGameBtn = document.getElementById('start-game-btn');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');


            // --- GAME STATE ---
            let gameState = {
                gameData: null,
                currentRound: 0,
                questionIndex: 0,
                activeTeamIndex: 0,
                teams: [
                    { name: 'Team 1', score: 0 },
                    { name: 'Team 2', score: 0 }
                ]
            };
            let questionCounters = { 1: 0, 2: 0, 3: 0 };
            let timerInterval;
            let timeLeft = 60;

            const INSTRUCTIONS = {
                1: { title: "EMEA Feud", text: `
                    <p><strong>Objective:</strong> A case study of a potential client will be presented. Your team's goal is to uncover the client's key pain points by guessing the 5 most critical questions.</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Your team has <strong>3 minutes</strong> to discuss the case study.</li>
                        <li>If your team makes <strong>2 wrong attempts</strong>, the turn passes to the next team for a steal.</li>
                        <li><strong>Scoring:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>10 points</strong> for every correct question.</li>
                                <li><strong>40 bonus points</strong> if your team correctly guesses all 5 questions.</li>
                                <li><strong>30 bonus points</strong> if another team successfully steals and completes the set of 5 questions.</li>
                            </ul>
                        </li>
                    </ul>` },
                2: { title: "Fastest Finger First", text: `
                    <p><strong>Objective:</strong> Test your quick calculation and knowledge of key metrics.</p>
                    <ul class="list-disc list-inside mt-2">
                        <li>The first team to use the buzzer gets <strong>5 seconds</strong> to answer.</li>
                        <li>A correct answer earns <strong>40 points</strong>.</li>
                        <li>A wrong answer deducts <strong>20 points</strong>.</li>
                        <li>Questions are not passed to other teams.</li>
                    </ul>` },
                3: { title: "KPI Identifier", text: `
                    <p><strong>Objective:</strong> Analyze a sponsor/champion persona and identify their relevant KPIs.</p>
                     <ul class="list-disc list-inside mt-2">
                        <li>You have <strong>2 minutes</strong> to guess all relevant KPIs for the stakeholder.</li>
                        <li>The top 6 KPIs will be identified. Every correct guess earns <strong>10 points</strong>.</li>
                        <li>You can use a <strong>Joker</strong> to double your points if you think you can guess all 6 correctly.</li>
                    </ul>` }
            };

            // --- LOCAL STORAGE LOGIC ---
            function saveGameState() {
                const stateToSave = {
                    teams: gameState.teams,
                    counters: questionCounters
                };
                localStorage.setItem('2fast2curiousState', JSON.stringify(stateToSave));
            }

            function loadGameState() {
                const savedState = localStorage.getItem('2fast2curiousState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    gameState.teams = parsedState.teams || [{ name: 'Team 1', score: 0 }, { name: 'Team 2', score: 0 }];
                    questionCounters = parsedState.counters || { 1: 0, 2: 0, 3: 0 };
                }
            }

            // --- SCOREBOARD LOGIC ---
            function renderScoreboard() {
                teamsContainer.innerHTML = '';
                gameState.teams.forEach((team, index) => {
                    const teamEl = document.createElement('div');
                    teamEl.className = 'team-card flex items-center gap-2 bg-gray-800 p-2 rounded-lg border-2 border-transparent transition-all';
                    if (index === gameState.activeTeamIndex) {
                        teamEl.classList.add('active');
                    }
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-bold cursor-pointer';
                    nameSpan.textContent = team.name;
                    nameSpan.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = team.name;
                        input.className = 'team-name-input';
                        nameSpan.replaceWith(input);
                        input.focus();
                        input.addEventListener('blur', () => {
                            if (input.value.trim()) {
                                gameState.teams[index].name = input.value.trim();
                            }
                            renderScoreboard();
                            saveGameState();
                        });
                        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
                    });

                    const scoreSpan = document.createElement('span');
                    scoreSpan.className = 'text-2xl font-black text-yellow-300 w-12 text-center';
                    scoreSpan.textContent = team.score;

                    const plusBtn = document.createElement('button');
                    plusBtn.className = 'btn bg-green-500 text-white rounded-full h-6 w-6 flex items-center justify-center';
                    plusBtn.textContent = '+';
                    plusBtn.addEventListener('click', () => {
                        gameState.teams[index].score += 10;
                        renderScoreboard();
                        saveGameState();
                    });

                    const minusBtn = document.createElement('button');
                    minusBtn.className = 'btn bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center';
                    minusBtn.textContent = '-';
                    minusBtn.addEventListener('click', () => {
                        gameState.teams[index].score -= 10;
                        renderScoreboard();
                        saveGameState();
                    });
                    
                    teamEl.appendChild(nameSpan);
                    teamEl.appendChild(minusBtn);
                    teamEl.appendChild(scoreSpan);
                    teamEl.appendChild(plusBtn);
                    teamsContainer.appendChild(teamEl);
                });
            }

            addTeamBtn.addEventListener('click', () => {
                gameState.teams.push({ name: `Team ${gameState.teams.length + 1}`, score: 0 });
                renderScoreboard();
                saveGameState();
            });

            newGameBtn.addEventListener('click', () => {
                modalText.textContent = "Are you sure you want to start a new game? All team names and scores will be reset.";
                confirmationModal.classList.remove('hidden');

                const handleConfirm = () => {
                    localStorage.removeItem('2fast2curiousState');
                    gameState.teams = [ { name: 'Team 1', score: 0 }, { name: 'Team 2', score: 0 }];
                    questionCounters = { 1: 0, 2: 0, 3: 0 };
                    renderScoreboard();
                    closeModal();
                };

                const closeModal = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', closeModal);
                };

                modalConfirmBtn.addEventListener('click', handleConfirm, { once: true });
                modalCancelBtn.addEventListener('click', closeModal, { once: true });
            });


            homeBtn.addEventListener('click', () => {
                showPage('mainMenu');
            });

            // --- NAVIGATION ---
            function showPage(pageName) {
                Object.values(pages).forEach(page => page.classList.remove('active'));
                pages[pageName].classList.add('active');
            }

            document.querySelectorAll('.navigate-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const round = parseInt(e.currentTarget.dataset.round);
                    gameState.currentRound = round;
                    instructionsTitle.textContent = INSTRUCTIONS[round].title;
                    instructionsText.innerHTML = INSTRUCTIONS[round].text;
                    showPage('instructions');
                });
            });

            startGameBtn.addEventListener('click', () => {
                const gameData = getGameContentFromSheet(gameState.currentRound);
                if (!gameData) {
                    showMessage("All questions for this round have been played. Start a 'New Game' to play again.", false);
                    showPage('mainMenu');
                    return;
                }
                
                gameState.gameData = gameData;
                gameState.questionIndex = 0;
                
                renderGame();
                showPage('game');
            });

            backToMenuBtn.addEventListener('click', () => {
                showPage('mainMenu');
            });

            // --- TIMER LOGIC ---
            function startTimer() {
                clearInterval(timerInterval); 
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function resetTimer() {
                clearInterval(timerInterval);
                timeLeft = 60;
                timerDisplay.textContent = timeLeft;
            }

            timerStartBtn.addEventListener('click', startTimer);
            timerStopBtn.addEventListener('click', stopTimer);
            timerResetBtn.addEventListener('click', resetTimer);

            // --- GAME LOGIC ---
            function renderGame() {
                switch (gameState.currentRound) {
                    case 1: renderFamilyFeud(); break;
                    case 2: renderFastestFingerFirst(); break;
                    case 3: renderKPIIdentifier(); break;
                }
                const modBtn = document.getElementById('moderator-view-btn-game');
                if(modBtn) {
                    modBtn.addEventListener('click', openModeratorViewInNewTab);
                }
            }

            function refreshContent(round, btn) {
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                
                setTimeout(() => { // Simulate a small delay for user feedback
                    const gameData = getGameContentFromSheet(round);
                    if (!gameData) {
                        gameContent.innerHTML = `<div class="text-center text-xl font-bold text-yellow-400">You've completed all questions for this round!<br>Start a 'New Game' from the main menu to play again.</div>`;
                        return;
                    }
                    gameState.gameData = gameData;
                    gameState.questionIndex = 0;
                    renderGame();
                }, 200);
            }
            
            function renderFamilyFeud() {
                const roundData = gameState.gameData.familyFeud;
                let questionsHTML = roundData.questions.map((item, index) => `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <div class="flex items-center gap-4">
                            <p id="feud-question-${index}" class="font-bold text-lg flex-grow text-left blur-sm transition-all">${item.q}</p>
                            <button data-target="feud-question-${index}" class="show-question-btn btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show</button>
                        </div>
                    </div>
                `).join('');

                gameContent.innerHTML = `
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <h2 class="text-3xl font-bold">EMEA Feud Case Study</h2>
                        <button id="moderator-view-btn-game" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-md text-sm">Moderator View</button>
                        <button id="refresh-feud-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Next Case</button>
                    </div>
                    <p class="text-lg text-gray-300 mb-6 bg-gray-900 p-4 rounded-lg">${roundData.case}</p>
                    <div class="space-y-4">${questionsHTML}</div>`;
                
                document.getElementById('refresh-feud-btn').addEventListener('click', (e) => refreshContent(1, e.currentTarget));
                document.querySelectorAll('.show-question-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.target;
                        document.getElementById(targetId).classList.remove('blur-sm');
                        e.currentTarget.style.display = 'none';
                    });
                });
            }
            
            function renderFastestFingerFirst() {
                const roundData = gameState.gameData.fastestFinger;
                const currentQuestion = roundData[gameState.questionIndex];

                let questionHTML = `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="text-lg">${currentQuestion.scenario}</p>
                        <p class="font-bold text-xl mt-2">${currentQuestion.question}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <p id="fff-answer" class="text-green-400 text-lg font-bold mt-2 blur-sm transition-all flex-grow text-left">${currentQuestion.answer}</p>
                            <button data-target="fff-answer" class="show-answer-btn btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show Answer</button>
                        </div>
                    </div>`;
                
                const isLastQuestion = gameState.questionIndex >= roundData.length - 1;
                let navigationButtonsHTML = isLastQuestion 
                    ? `<button id="next-scenarios-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Next Scenarios</button>`
                    : `<button id="next-fff-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Next Question</button>`;

                gameContent.innerHTML = `
                    <div class="text-center mb-6 flex justify-center items-center gap-4">
                        <h2 class="text-3xl font-bold">Fastest Finger First</h2>
                        <button id="moderator-view-btn-game" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-md text-sm">Moderator View</button>
                    </div>
                    <div class="space-y-4">${questionHTML}</div>
                     <div class="text-center mt-4">
                        ${navigationButtonsHTML}
                    </div>`;

                document.querySelector('.show-answer-btn').addEventListener('click', (e) => {
                    document.getElementById(e.currentTarget.dataset.target).classList.remove('blur-sm');
                    e.currentTarget.style.display = 'none';
                });

                if (isLastQuestion) {
                    document.getElementById('next-scenarios-btn').addEventListener('click', (e) => refreshContent(2, e.currentTarget));
                } else {
                    document.getElementById('next-fff-btn').addEventListener('click', () => {
                        gameState.questionIndex++;
                        renderFastestFingerFirst();
                    });
                }
            }

            function renderKPIIdentifier() {
                const roundData = gameState.gameData.kpiIdentifier;
                const kpiListHTML = roundData.kpis.map(kpi => `<li class="kpi-list-item">${kpi}</li>`).join('');

                gameContent.innerHTML = `
                    <div class="text-center">
                        <div class="flex justify-center items-center gap-4 mb-2">
                            <h2 class="text-3xl font-bold">Whatfix Champion Persona</h2>
                             <button id="moderator-view-btn-game" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-md text-sm">Moderator View</button>
                        </div>
                        <h3 class="text-4xl font-bold text-yellow-300 mb-4">${roundData.role}</h3>
                        <p class="text-lg text-gray-300 max-w-4xl mx-auto mb-8">${roundData.description}</p>
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <h4 class="text-2xl font-bold">Potential KPIs</h4>
                            <button id="show-kpis-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show KPIs</button>
                        </div>
                        <ul id="kpi-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center blur-md transition-all">${kpiListHTML}</ul>
                        <div class="text-center mt-4">
                            <button id="next-kpi-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Next Persona</button>
                        </div>
                    </div>`;

                document.getElementById('next-kpi-btn').addEventListener('click', (e) => refreshContent(3, e.currentTarget));
                document.getElementById('show-kpis-btn').addEventListener('click', (e) => {
                    document.getElementById('kpi-list').classList.remove('blur-md');
                    e.currentTarget.style.display = 'none';
                });
            }
            
            function openModeratorViewInNewTab() {
                const content = getModeratorContentHTML();
                const newTab = window.open();
                newTab.document.write(`
                    <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Moderator View</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"><style>body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; } .game-board { background-color: #1f2937; border: 1px solid #374151; } .kpi-list-item { background-color: #374151; padding: 0.75rem; border-radius: 0.5rem; font-weight: 500; }</style></head><body class="p-8"><div class="game-board p-6 rounded-2xl shadow-2xl max-w-4xl mx-auto">${content}</div></body></html>
                `);
                newTab.document.close();
            }

            function getModeratorContentHTML() {
                const round = gameState.currentRound;
                const data = gameState.gameData;
                let content = '';

                if (!data) return '<p>No game has been started yet.</p>';

                if (round === 1) {
                    const roundData = data.familyFeud;
                    let questionsHTML = roundData.questions.map(item => `<div class="p-4 bg-gray-800 rounded-lg text-left"><p class="font-bold text-lg">${item.q}</p></div>`).join('');
                    content = `<h2 class="text-3xl font-bold text-center mb-4">EMEA Feud (Moderator)</h2><p class="text-lg text-gray-300 mb-6 bg-gray-900 p-4 rounded-lg">${roundData.case}</p><div class="space-y-4">${questionsHTML}</div>`;
                } else if (round === 2) {
                     const roundData = data.fastestFinger;
                     let questionsHTML = roundData.map(item => `<div class="p-4 bg-gray-800 rounded-lg text-left"><p class="text-lg">${item.scenario}</p><p class="font-bold text-xl mt-2">${item.question}</p><p class="text-green-400 text-lg font-bold mt-2">${item.answer}</p></div>`).join('');
                    content = `<h2 class="text-3xl font-bold text-center mb-6">Fastest Finger First (Answers)</h2><div class="space-y-4">${questionsHTML}</div>`;
                } else if (round === 3) {
                    const roundData = data.kpiIdentifier;
                    const kpiListHTML = roundData.kpis.map(kpi => `<li class="kpi-list-item">${kpi}</li>`).join('');
                    content = `<div class="text-center"><h2 class="text-3xl font-bold mb-2">Whatfix Champion Persona</h2><h3 class="text-4xl font-bold text-yellow-300 mb-4">${roundData.role}</h3><p class="text-lg text-gray-300 max-w-4xl mx-auto mb-8">${roundData.description}</p><h4 class="text-2xl font-bold mb-4">Potential KPIs</h4><ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center">${kpiListHTML}</ul></div>`;
                }
                return content;
            }

            function showMessage(message, isError = false) {
                messageArea.textContent = message;
                messageArea.className = isError ? 'text-red-500 my-4 h-6 font-semibold' : 'text-yellow-400 my-4 h-6 font-semibold';
                setTimeout(() => { messageArea.textContent = ''; }, 4000);
            }

            // --- Game Content from CSV ---
            const allQuestions = {
                "EMEA Feud": [
                    { case: "A large German automotive manufacturer, AutoWerk GmbH, is rolling out a new, highly customized Salesforce instance to its global sales and service teams. Adoption has been slow, with many employees in their non-German-speaking offices reverting to old spreadsheets. They are facing inconsistent data entry, and the training team is overwhelmed with requests for basic how-to guidance.", questions: ["How are you currently measuring user adoption and proficiency across different regions and languages?", "What is the average time it takes to onboard a new sales or service team member onto the new Salesforce platform?", "Can you quantify the business impact of inconsistent or inaccurate data in your sales pipeline?", "How much time is your central training team spending on creating and updating support documentation versus strategic tasks?", "What process is in place to support employees when a critical sales or service process is updated within Salesforce?"] },
                    { case: "Banque Dubois, a major retail bank in France, has just launched a new internal compliance application to adhere to recent EU financial regulations. The application is complex, and bank tellers are making frequent errors, leading to compliance risks and frustrated customers. The support desk has seen a 200% increase in tickets related to this new software.", questions: ["What are the financial or regulatory penalties associated with an employee failing to follow the correct process in the new compliance app?", "How do you ensure that all 10,000 of your tellers are instantly proficient when a critical compliance workflow is updated?", "What percentage of your support desk's time is currently dedicated to answering procedural questions about the new application?", "How are you tracking the completion and effectiveness of your current training for this new tool?", "How much productivity is lost when an employee has to stop their work to find help or look up how to complete a task?"] },
                    { case: "A UK-based pharmaceutical company uses Veeva CRM to manage its field sales interactions. There is high turnover in their sales team, and new reps take over 6 months to become fully productive. They have a massive library of training PowerPoints and PDFs, but reps complain they can't find what they need when they need it.", questions: ["What is the average cost to the business for every month a new sales rep is not fully productive on Veeva?", "How do you currently ensure that all sales reps are following the most up-to-date, approved messaging and processes?", "What is the direct impact on your sales forecast accuracy when data isn't entered into the CRM correctly and on time?", "How do you support your sales reps in the moments they are actually using the CRM and need immediate help?", "How do you measure the ROI of your current sales training content and methodologies?"] },
                    { case: "A Scandinavian logistics giant, Nordic Sped, is migrating from a legacy system to SAP S/4HANA for its supply chain management. The go-live is in three months, and user acceptance testing has revealed that warehouse staff are struggling with the new workflows, leading to significant data entry errors and shipping delays.", questions: ["What is the potential cost of a single shipping delay or data error caused by improper use of the new SAP system?", "How will you train and support your entire warehouse staff, who work in different shifts and speak multiple languages, simultaneously on go-live day?", "What is your strategy for reducing the expected surge in IT support tickets immediately following the launch?", "How do you plan to manage and communicate changes to SAP workflows to all users after the initial launch?", "How will you certify that every employee is proficient in the critical tasks before they get access to the live production environment?"] },
                    { case: "An Italian luxury fashion retailer is deploying Microsoft Dynamics 365 across its European stores. They hire many temporary staff during peak holiday seasons who must be trained quickly on inventory and point-of-sale processes. Last season, high training overhead and transaction errors led to lost sales and frustrated customers.", questions: ["How do you quantify the revenue lost due to transaction errors or slow checkout times during your peak sales season?", "What is the current cost and time required to get a seasonal employee fully competent on your POS system?", "How do you ensure a consistent, premium customer experience when your staff is constantly changing?", "What is your process for rapidly deploying updates to promotions or sales processes across all stores?", "How much are you spending on re-training temporary staff who return for another season but have forgotten the processes?"] },
                    { case: "A Swiss private wealth management firm is implementing a new, custom-built portfolio management platform to provide bespoke services to high-net-worth clients. The platform is powerful but not intuitive. Relationship managers, used to older methods, are avoiding the tool, jeopardizing the firm's goal of offering a unified, data-driven advisory experience.", questions: ["How does the lack of adoption of the new platform impact your firm's ability to demonstrate a competitive advantage to prospective clients?", "What is the compliance risk if advisors are not using the approved platform for tracking client interactions and financial advice?", "How are you measuring the opportunity cost of your relationship managers spending time struggling with software instead of engaging with clients?", "What is the strategy to ensure that all advisors can master new features as the platform evolves with market demands?", "How does inconsistent platform usage affect the accuracy of the firm-wide financial data used by leadership for strategic planning?"] },
                    { case: "A large hospitality group based in Dubai is rolling out a new Oracle OPERA Cloud property management system to its portfolio of hotels. The front-desk staff has a high turnover rate and diverse linguistic backgrounds. The group is concerned that inconsistent check-in processes will negatively impact their guest satisfaction scores.", questions: ["How do you directly correlate guest satisfaction scores (NPS/CSAT) with the speed and efficiency of your check-in and check-out process?", "What is the current 'time-to-competency' for a new front-desk employee, and what is the cost associated with this training period?", "How do you ensure every employee, regardless of their native language, follows the exact same procedure for high-value tasks like room upgrades or handling billing disputes?", "What is the financial impact of a single booking error or an incorrectly processed payment due to user error in the system?", "How do you provide on-demand support to your 24/7 staff during night shifts when training or IT teams are unavailable?"] },
                    { case: "A Netherlands-based public sector organization is responsible for processing citizen applications for social benefits through a new online portal built on ServiceNow. Caseworkers are finding it difficult to navigate the complex eligibility rules and workflows, causing a significant backlog and delaying aid to vulnerable citizens.", questions: ["What is the target processing time for a citizen's application, and how does the current backlog compare to that service-level agreement (SLA)?", "How do you ensure every caseworker applies the complex and frequently changing eligibility rules with 100% accuracy?", "What is the operational cost of having to re-work applications that were processed incorrectly?", "How are you training caseworkers on new policies and portal updates to ensure immediate compliance?", "How does the application backlog impact the public perception and trust in your organization's ability to serve citizens effectively?"] },
                    { case: "An Irish tech company is acquiring a smaller startup and needs to migrate the acquired sales team from their old CRM (Pipedrive) to the company's standard Salesforce instance. The acquired team is resistant to change, and leadership is concerned about a post-acquisition dip in sales productivity and morale.", questions: ["What is your primary concern regarding a potential drop in sales performance in the first quarter post-acquisition?", "How do you plan to onboard the acquired team onto a completely new sales process and technology stack without causing disruption?", "What is the strategy for harmonizing the sales data from two different CRMs to create a single source of truth for forecasting?", "How will you provide immediate, in-the-flow-of-work support to a team that is culturally accustomed to a different way of working?", "How will you measure the success of this integration in terms of both sales productivity and employee sentiment?"] },
                    { case: "A Spanish renewable energy company uses a custom-built project management tool to oversee the construction of wind farms. The tool requires engineers to follow strict safety and environmental compliance protocols. Recent audits have revealed inconsistent reporting, putting the company at risk of regulatory fines and project delays.", questions: ["Can you quantify the potential financial impact of a single compliance breach or safety violation on a project?", "How do you currently certify that every engineer on every site is proficient in the latest compliance reporting procedures?", "What is the cost of project delays caused by administrative errors or incomplete data entry in your management tool?", "How do you provide performance support to engineers who are working in remote, often offline, field locations?", "How much time are your senior engineers spending on correcting reports versus their core engineering responsibilities?"] },
                    { case: "A Belgian university is deploying Workday for its HR and student management processes. The administrative staff, many of whom have been with the university for decades, are struggling to adapt from paper-based processes to the new digital workflows. This is causing delays in student registration and payroll processing.", questions: ["How are the delays in student registration impacting the university's revenue and student satisfaction at the start of a semester?", "What is the risk associated with payroll errors caused by incorrect data entry into the new Workday system?", "What is your strategy for training a diverse, non-technical user base that is highly resistant to technological change?", "How do you plan to manage the surge in support requests from thousands of staff and students during peak periods like enrollment and exams?", "How will you ensure that sensitive employee and student data is handled correctly and securely within the new system?"] },
                    { case: "A major airline based in the UAE is using a new crew scheduling software to optimize flight assignments. The complexity of union rules, flight regulations, and crew qualifications is leading to scheduling errors. These errors cause flight delays and crew shortages, resulting in significant operational costs and customer dissatisfaction.", questions: ["What is the average cost to the airline for a single flight delay or cancellation caused by a crew scheduling error?", "How do you ensure that every scheduler is 100% compliant with the complex and ever-changing aviation regulations and union agreements?", "How much time is spent manually correcting schedules versus allowing the system to automate the process?", "What is your process for rapidly training schedulers on new routes or aircraft that introduce new scheduling constraints?", "How does crew morale and attrition relate to the fairness and accuracy of the scheduling process?"] },
                ],
                "Fastest Finger First": [
                    { scenario: "A SaaS company starts the quarter with an MRR of $200,000. Over the quarter, they add $30,000 in new MRR from new customers. They also add $15,000 in expansion MRR from existing customers. However, they lost $25,000 in MRR from churning customers.", question: "What is their Net Revenue Retention (NRR) for the quarter?", answer: "95%" },
                    { scenario: "An engineering team starts work on a feature on Monday. It moves through development, testing, and is finally deployed to production on the following Monday, exactly 7 days later.", question: "What is the Cycle Time for this feature in days?", answer: "7 days" },
                    { scenario: "A company had 500 customers at the beginning of the year. By the end of the year, 45 of those original customers had cancelled their subscriptions.", question: "What was the company's annual Customer Churn Rate?", answer: "9%" },
                    { scenario: "A Customer Success Manager is trying to demonstrate the value of their product. It takes 5 days for implementation, 10 days for user training, and 15 days for the customer to see their first positive business outcome.", question: "What is the total Time to Value (TTV) in days?", answer: "30 days" },
                    { scenario: "An agile team planned to complete 80 story points in a 2-week sprint. At the end of the sprint, they had completed 60 story points.", question: "What is the team's Velocity for this sprint?", answer: "60" },
                    { scenario: "A company surveys 200 customers. 100 are Promoters (9-10), 60 are Passives (7-8), and 40 are Detractors (0-6).", question: "What is the company's Net Promoter Score (NPS)?", answer: "30" },
                    { scenario: "A project was scheduled to have $50,000 worth of work completed by today. However, only $40,000 worth of work has actually been finished.", question: "What is the Schedule Variance (SV) for this project, and is it favorable or unfavorable?", answer: "-$10,000 (Unfavorable)" },
                    { scenario: "A project has two paths of sequential tasks. Path A takes 5 + 3 + 4 = 12 days. Path B takes 2 + 6 + 2 = 10 days.", question: "What is the duration of the Critical Path for this project?", answer: "12 days" },
                    { scenario: "A customer pays a subscription of $2,000 per year. The company's gross margin is 80%, and the customer churn rate is 10% per year.", question: "What is the Customer Lifetime Value (CLV) for this customer?", answer: "$16,000" },
                    { scenario: "A customer support center handles 500 support tickets in a day. 400 of these tickets were resolved and closed within the first interaction.", question: "What is the First Contact Resolution (FCR) rate for the day?", answer: "80%" },
                    { scenario: "A project team starts a 10-day sprint with 100 story points of work planned. After 5 days (halfway through the sprint), they have completed 60 story points.", question: "What does the team's Burndown Rate indicate about their progress?", answer: "They are ahead of schedule." },
                    { scenario: "In a given month, 200 new customers sign up for a product. Of those, 150 successfully complete all the mandatory onboarding steps within their first 30 days.", question: "What is the Customer Onboarding Completion Rate for that month?", answer: "75%" },
                ],
                "KPI Identifier": [
                    { role: "Chief Information Officer (CIO)", description: "The CIO of a multinational corporation is under pressure to maximize the ROI of their massive software portfolio, which includes Workday, Salesforce, and SAP. They are concerned about rising IT support costs, low employee productivity on these complex systems, and the security risks associated with poor data entry and process adherence.", kpis: ["Reduction in software-related IT support tickets", "Increase in employee self-service rates", "Improvement in data quality and process compliance", "Acceleration of user onboarding time for new applications", "Higher adoption rates for key software features", "Increased ROI on enterprise software investments"] },
                    { role: "Sales Operations Manager", description: "The Sales Ops Manager at a fast-growing B2B tech company is struggling to enforce consistent processes in Salesforce. New sales reps take too long to ramp up, data for forecasting is often incomplete or inaccurate, and the sales team constantly complains that they can't remember the correct steps for complex deal registrations or quoting procedures.", kpis: ["Reduction in new sales rep time-to-first-deal", "Increase in CRM data integrity and completeness", "Higher adherence to the defined sales methodology", "Reduction in 'how-to' requests to the sales ops team", "Faster rollout and adoption of new sales tools", "Improvement in sales forecast accuracy"] },
                    { role: "Training Lead", description: "The Training Lead for a large contact center is responsible for onboarding hundreds of new agents per year on a suite of tools including Zendesk and an internal order management system. They find that classroom-style training is ineffective, as agents forget most of it by the time they take their first call. This leads to long handling times and poor customer satisfaction scores.", kpis: ["Decrease in new agent onboarding and ramp-up time", "Reduction in Average Handle Time (AHT)", "Increase in First Call Resolution (FCR) rates", "Improvement in agent compliance with key processes", "Higher agent confidence and satisfaction scores", "Reduction in costs associated with re-training"] },
                    { role: "Head of Digital Transformation", description: "This leader is responsible for driving the successful adoption of new digital tools across the entire organization. Their biggest challenge is overcoming employee resistance to change and ensuring that the company realizes the promised benefits of its multi-million dollar technology investments. They need a way to make change less disruptive and empower employees to adapt quickly.", kpis: ["Faster user adoption of new enterprise applications", "Reduction in productivity dips during technology rollouts", "Increased employee engagement with new digital initiatives", "Lower costs associated with change management programs", "Accelerated time-to-value for new technology platforms", "Improvement in overall organizational agility"] },
                    { role: "VP of Sales", description: "The VP of Sales is focused on hitting aggressive revenue targets. They are concerned that inconsistent CRM usage is leading to an inaccurate sales pipeline, missed opportunities, and a long sales cycle. They need their global sales team to follow a unified, data-driven sales process.", kpis: ["Increased sales velocity", "Shortened sales cycle length", "Improved sales forecast accuracy", "Higher lead-to-opportunity conversion rate", "Increased adoption of the standard sales methodology", "Reduction in sales rep ramp time"] },
                    { role: "Product Owner", description: "The Product Owner for an internal software application is frustrated. User feedback is consistently negative, with users complaining that the application is not intuitive. The development team spends too much time fixing user errors instead of building new features, and adoption of new releases is extremely low.", kpis: ["Increased user satisfaction scores (CSAT/NPS)", "Reduction in user-generated error rates", "Decrease in 'how-to' support tickets", "Faster adoption of new features and releases", "Increased daily/monthly active users (DAU/MAU)", "Positive shift in qualitative user feedback"] },
                    { role: "Change Manager", description: "A Change Manager is overseeing the rollout of Oracle Fusion Cloud ERP. Their primary goal is to ensure a smooth transition with minimal disruption to business operations. They are measured on how quickly and effectively employees adapt to the new system and processes.", kpis: ["Reduction in employee productivity dip during go-live", "Achievement of target user adoption rates by deadline", "Decrease in change-related resistance and negative feedback", "Reduction in post-launch IT support ticket volume", "Faster completion of user acceptance testing (UAT)", "High completion rates for mandatory training modules"] },
                    { role: "Head of Customer Success", description: "The Head of CS is battling a high customer churn rate. They've identified that a poor and inconsistent onboarding experience is the leading cause. Customers are not realizing the product's value quickly enough, leading to low engagement and eventual cancellation.", kpis: ["Increased Net Revenue Retention (NRR)", "Reduction in customer churn rate", "Decrease in Time to First Value (TTFV)", "Higher product adoption/engagement scores in the first 90 days", "Increased Onboarding Completion Rate", "Improvement in customer health scores"] },
                    { role: "IT Application Manager", description: "This manager is responsible for a portfolio of applications. They are spending too much budget on application support and maintenance. Users constantly need help with basic tasks, and the IT team has no visibility into how features are actually being used, making it difficult to plan for future upgrades.", kpis: ["Reduction in total cost of ownership (TCO) for applications", "Increased employee self-service for support issues", "Reduction in application maintenance and support overhead", "Improved visibility into application feature usage", "Faster and more efficient application upgrade cycles", "Increased user sentiment score for IT-managed tools"] },
                    { role: "Chief Financial Officer - CFO", description: "The CFO is focused on financial governance and efficiency. They have approved a significant investment in a new procurement system (like Coupa or SAP Ariba) to control spending and streamline processes, but are concerned about employee compliance and realizing the projected cost savings.", kpis: ["Increased percentage of spend under management", "Higher compliance with preferred supplier policies", "Reduction in invoice processing time and cost", "Improved accuracy of financial data and reporting", "Faster new employee onboarding onto financial systems", "Achievement of projected ROI for the new system"] },
                    { role: "HRIS Manager", description: "The HRIS Manager is responsible for the company's Workday instance. During open enrollment and performance review cycles, the HR team is flooded with repetitive questions from employees on how to complete tasks in the system. This prevents the HR team from focusing on more strategic initiatives.", kpis: ["Reduction in 'how-to' queries to the HR team during peak cycles", "Increased employee self-sufficiency in HR processes", "Improved data accuracy in employee records", "Faster completion rates for performance reviews", "Higher employee satisfaction with HR systems", "Reduction in time spent by HR team on administrative support"] },
                    { role: "Chief Operating Officer - COO", description: "The COO is responsible for the overall operational efficiency of the company. They are concerned that disparate systems and inconsistent processes across different departments are creating bottlenecks, increasing operational risk, and making it difficult to scale the business effectively.", kpis: ["Improvement in cross-departmental process cycle times", "Reduction in operational error rates", "Increased adherence to standard operating procedures (SOPs)", "Faster onboarding and time-to-productivity for new hires", "Improved scalability of business operations", "Reduction in operational risk and compliance breaches"] },
                ]
            };

            function getGameContentFromSheet(round) {
                let data = null;
                if (round === 1) {
                    const roundData = allQuestions["EMEA Feud"];
                    const currentIndex = questionCounters[1];
                    if (currentIndex >= roundData.length) return null;
                    const selected = roundData[currentIndex];
                    questionCounters[1]++;
                    data = { familyFeud: { case: selected.case, questions: selected.questions.map(q => ({ q })) } };
                } else if (round === 2) {
                    const roundData = allQuestions["Fastest Finger First"];
                    const blockIndex = questionCounters[2];
                    const startIndex = blockIndex * 3;
                    if (startIndex >= roundData.length) return null;
                    const selected = roundData.slice(startIndex, startIndex + 3);
                    questionCounters[2]++;
                    data = { fastestFinger: selected };
                } else if (round === 3) {
                    const roundData = allQuestions["KPI Identifier"];
                    const currentIndex = questionCounters[3];
                    if (currentIndex >= roundData.length) return null;
                    const selected = roundData[currentIndex];
                    questionCounters[3]++;
                    data = { kpiIdentifier: { role: selected.role, description: selected.description, kpis: selected.kpis } };
                }
                saveGameState();
                return data;
            }
            
            // Initial setup
            loadGameState();
            renderScoreboard();
        });
    </script>
</body>
</html>

