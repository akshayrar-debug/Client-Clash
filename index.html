<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Clash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
            padding-top: 120px; /* Increased space for the fixed scoreboard and timer */
        }
        .game-board {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .kpi-list-item {
            background-color: #374151;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .team-name-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            width: 120px;
        }
        .team-card.active {
             box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
             border-color: #3b82f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 relative">

    <!-- Scoreboard Bar -->
    <div id="scoreboard-bar" class="absolute top-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 p-4 z-20">
        <div class="w-full max-w-7xl mx-auto flex items-center gap-4">
            <div id="teams-container" class="flex items-center gap-4"></div>
            <button id="add-team-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Add Team</button>
        </div>
    </div>

    <!-- Independent Timer -->
    <div id="timer-container" class="absolute top-24 right-4 game-board p-4 rounded-2xl shadow-lg flex items-center space-x-4 z-10">
        <div id="timer-display" class="text-5xl text-red-500 font-black">60</div>
        <div class="flex flex-col space-y-2">
            <button id="timer-start-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Start</button>
            <button id="timer-stop-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-1 px-3 rounded-md text-sm">Stop</button>
            <button id="timer-reset-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-sm">Reset</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6 pt-4">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Client Clash</h1>
            <p class="text-gray-400 mt-2">The Ultimate Game for CS and PM Professionals</p>
        </header>

        <!-- Main Content -->
        <main id="game-container">
            <!-- Main Menu Page -->
            <div id="main-menu-page" class="page active">
                <div class="game-board p-6 rounded-2xl shadow-2xl text-center">
                    <h2 class="text-3xl font-bold mb-6">Choose a Game</h2>
                    <div id="message-area" class="my-4 h-6 font-semibold"></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center">
                        <button data-round="1" class="navigate-btn btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">EMEA Feud</button>
                        <button data-round="3" class="navigate-btn btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">KPI Identifier</button>
                        <button data-round="2" class="navigate-btn btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">Fastest Finger First</button>
                    </div>
                    <div class="mt-6">
                        <button id="moderator-view-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg" disabled>Moderator View</button>
                    </div>
                </div>
            </div>

            <!-- Instructions Page -->
            <div id="instructions-page" class="page">
                <div class="game-board p-6 rounded-2xl shadow-2xl text-center">
                    <h2 id="instructions-title" class="text-3xl font-bold mb-4"></h2>
                    <div id="instructions-text" class="text-lg text-left text-gray-300 max-w-3xl mx-auto mb-6 space-y-2"></div>
                    <div id="loading-state-instructions" class="hidden my-4">
                        <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-lg text-gray-300">AI is generating your game... Please wait.</p>
                    </div>
                    <button id="start-game-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">Start Game</button>
                </div>
            </div>

            <!-- Game Page -->
            <div id="game-page" class="page">
                 <div id="game-content-wrapper" class="game-board p-6 rounded-2xl shadow-2xl">
                    <!-- Game Content (Dynamically populated) -->
                    <div id="game-content"></div>
                     <div class="text-center mt-6">
                        <button id="back-to-menu-btn" class="btn bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg">Back to Menu</button>
                    </div>
                </div>
            </div>

             <!-- Moderator Page -->
            <div id="moderator-page" class="page">
                 <div class="game-board p-6 rounded-2xl shadow-2xl">
                    <div id="moderator-content"></div>
                     <div class="text-center mt-6">
                        <button id="mod-back-to-menu-btn" class="btn bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg">Back to Menu</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const pages = {
                mainMenu: document.getElementById('main-menu-page'),
                instructions: document.getElementById('instructions-page'),
                game: document.getElementById('game-page'),
                moderator: document.getElementById('moderator-page'),
            };
            const gameContent = document.getElementById('game-content');
            const moderatorContent = document.getElementById('moderator-content');
            const loadingState = document.getElementById('loading-state-instructions');
            const messageArea = document.getElementById('message-area');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            const modBackToMenuBtn = document.getElementById('mod-back-to-menu-btn');
            const timerDisplay = document.getElementById('timer-display');
            const timerStartBtn = document.getElementById('timer-start-btn');
            const timerStopBtn = document.getElementById('timer-stop-btn');
            const timerResetBtn = document.getElementById('timer-reset-btn');
            const teamsContainer = document.getElementById('teams-container');
            const addTeamBtn = document.getElementById('add-team-btn');
            const instructionsTitle = document.getElementById('instructions-title');
            const instructionsText = document.getElementById('instructions-text');
            const startGameBtn = document.getElementById('start-game-btn');
            const moderatorViewBtn = document.getElementById('moderator-view-btn');

            // --- GAME STATE ---
            let gameState = {
                gameData: null,
                currentRound: 0,
                questionIndex: 0,
                activeTeamIndex: 0,
                teams: [
                    { name: 'Team 1', score: 0 },
                    { name: 'Team 2', score: 0 }
                ]
            };
            let timerInterval;
            let timeLeft = 60;

            const INSTRUCTIONS = {
                1: { title: "EMEA Feud", text: `
                    <p><strong>Objective:</strong> A case study of a potential client will be presented. Your team's goal is to uncover the client's key pain points by guessing the 5 most critical questions an AI has identified.</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Your team has <strong>2 minutes</strong> to discuss the case study.</li>
                        <li>After discussion, your team gets <strong>5 attempts</strong> to guess the critical questions.</li>
                        <li>If your team makes <strong>2 wrong attempts</strong>, the turn passes to the next team for a steal.</li>
                        <li><strong>Scoring:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>10 points</strong> for every correct question.</li>
                                <li><strong>40 bonus points</strong> if your team correctly guesses all 5 questions.</li>
                                <li><strong>30 bonus points</strong> if another team successfully steals and completes the set of 5 questions.</li>
                            </ul>
                        </li>
                    </ul>` },
                2: { title: "Fastest Finger First", text: `
                    <p><strong>Objective:</strong> Test your quick calculation and knowledge of key metrics.</p>
                    <ul class="list-disc list-inside mt-2">
                        <li>The first team to use the buzzer gets <strong>5 seconds</strong> to answer.</li>
                        <li>A correct answer earns <strong>40 points</strong>.</li>
                        <li>A wrong answer deducts <strong>20 points</strong>.</li>
                        <li>Questions are not passed to other teams.</li>
                    </ul>` },
                3: { title: "KPI Identifier", text: `
                    <p><strong>Objective:</strong> Analyze a sponsor/champion persona and identify their relevant KPIs.</p>
                     <ul class="list-disc list-inside mt-2">
                        <li>You have <strong>1 minute</strong> to guess all relevant KPIs for the stakeholder.</li>
                        <li>The AI will identify the top 6 KPIs. Every correct guess earns <strong>10 points</strong>.</li>
                        <li>You can use a <strong>Joker</strong> to double your points if you think you can guess all 6 correctly.</li>
                    </ul>` }
            };

            // --- SCOREBOARD LOGIC ---
            function renderScoreboard() {
                teamsContainer.innerHTML = '';
                gameState.teams.forEach((team, index) => {
                    const teamEl = document.createElement('div');
                    teamEl.className = 'team-card flex items-center gap-2 bg-gray-800 p-2 rounded-lg border-2 border-transparent transition-all';
                    if (index === gameState.activeTeamIndex) {
                        teamEl.classList.add('active');
                    }
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-bold cursor-pointer';
                    nameSpan.textContent = team.name;
                    nameSpan.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = team.name;
                        input.className = 'team-name-input';
                        nameSpan.replaceWith(input);
                        input.focus();
                        input.addEventListener('blur', () => {
                            if (input.value.trim()) {
                                gameState.teams[index].name = input.value.trim();
                            }
                            renderScoreboard();
                        });
                        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
                    });

                    const scoreSpan = document.createElement('span');
                    scoreSpan.className = 'text-2xl font-black text-yellow-300 w-12 text-center';
                    scoreSpan.textContent = team.score;

                    const plusBtn = document.createElement('button');
                    plusBtn.className = 'btn bg-green-500 text-white rounded-full h-6 w-6 flex items-center justify-center';
                    plusBtn.textContent = '+';
                    plusBtn.addEventListener('click', () => {
                        gameState.teams[index].score += 10;
                        renderScoreboard();
                    });

                    const minusBtn = document.createElement('button');
                    minusBtn.className = 'btn bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center';
                    minusBtn.textContent = '-';
                    minusBtn.addEventListener('click', () => {
                        gameState.teams[index].score -= 10;
                        renderScoreboard();
                    });

                    teamEl.appendChild(nameSpan);
                    teamEl.appendChild(minusBtn);
                    teamEl.appendChild(scoreSpan);
                    teamEl.appendChild(plusBtn);
                    teamsContainer.appendChild(teamEl);
                });
            }

            addTeamBtn.addEventListener('click', () => {
                gameState.teams.push({ name: `Team ${gameState.teams.length + 1}`, score: 0 });
                renderScoreboard();
            });

            // --- NAVIGATION ---
            function showPage(pageName) {
                Object.values(pages).forEach(page => page.classList.remove('active'));
                pages[pageName].classList.add('active');
            }

            document.querySelectorAll('.navigate-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const round = parseInt(e.currentTarget.dataset.round);
                    gameState.currentRound = round;
                    instructionsTitle.textContent = INSTRUCTIONS[round].title;
                    instructionsText.innerHTML = INSTRUCTIONS[round].text;
                    showPage('instructions');
                });
            });

            startGameBtn.addEventListener('click', async () => {
                loadingState.classList.remove('hidden');
                startGameBtn.style.display = 'none';

                try {
                    const gameData = await generateGameContent(gameState.currentRound);
                    if (!gameData) throw new Error("AI failed to generate game data.");
                    
                    gameState.gameData = gameData;
                    gameState.questionIndex = 0;
                    
                    renderGame();
                    showPage('game');
                    moderatorViewBtn.disabled = false;
                } catch (error) {
                    console.error("Error starting game:", error);
                    showMessage("Failed to start game. Please try again.", true);
                    showPage('mainMenu'); // Go back to menu on error
                } finally {
                    loadingState.classList.add('hidden');
                    startGameBtn.style.display = 'block';
                }
            });

            backToMenuBtn.addEventListener('click', () => {
                showPage('mainMenu');
            });
            modBackToMenuBtn.addEventListener('click', () => {
                showPage('mainMenu');
            });
            moderatorViewBtn.addEventListener('click', () => {
                renderModeratorView();
                showPage('moderator');
            });

            // --- TIMER LOGIC ---
            function startTimer() {
                clearInterval(timerInterval); // Prevent multiple intervals
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function resetTimer() {
                clearInterval(timerInterval);
                timeLeft = 60;
                timerDisplay.textContent = timeLeft;
            }

            timerStartBtn.addEventListener('click', startTimer);
            timerStopBtn.addEventListener('click', stopTimer);
            timerResetBtn.addEventListener('click', resetTimer);

            // --- GAME LOGIC ---
            function renderGame() {
                switch (gameState.currentRound) {
                    case 1: renderFamilyFeud(); break;
                    case 2: renderFastestFingerFirst(); break;
                    case 3: renderKPIIdentifier(); break;
                }
            }

            async function refreshContent(round, btn) {
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                
                try {
                    const gameData = await generateGameContent(round);
                    gameState.gameData = gameData;
                    gameState.questionIndex = 0;
                    renderGame();
                } catch (error) {
                     showMessage("Failed to refresh content.", true);
                     renderGame(); // Re-render to restore button state
                }
            }
            
            function renderFamilyFeud() {
                const roundData = gameState.gameData.familyFeud;
                let questionsHTML = roundData.questions.map((item, index) => `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="font-bold text-lg">${item.q}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <p id="feud-answer-${index}" class="text-green-400 blur-sm transition-all flex-grow text-left">${item.a}</p>
                            <button data-target="feud-answer-${index}" class="show-answer-btn btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show Answer</button>
                        </div>
                    </div>
                `).join('');

                gameContent.innerHTML = `
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <h2 class="text-3xl font-bold">EMEA Feud Case Study</h2>
                        <button id="refresh-feud-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Refresh Case</button>
                    </div>
                    <p class="text-lg text-gray-300 mb-6 bg-gray-900 p-4 rounded-lg">${roundData.case}</p>
                    <div class="space-y-4">${questionsHTML}</div>`;
                
                document.getElementById('refresh-feud-btn').addEventListener('click', (e) => refreshContent(1, e.currentTarget));
                document.querySelectorAll('.show-answer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.target;
                        document.getElementById(targetId).classList.remove('blur-sm');
                        e.currentTarget.style.display = 'none';
                    });
                });
            }
            
            function renderFastestFingerFirst() {
                const roundData = gameState.gameData.fastestFinger;
                const currentQuestion = roundData[gameState.questionIndex];

                let questionHTML = `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="text-lg">${currentQuestion.scenario}</p>
                        <p class="font-bold text-xl mt-2">${currentQuestion.question}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <p id="fff-answer" class="text-green-400 text-lg font-bold mt-2 blur-sm transition-all flex-grow text-left">${currentQuestion.answer}</p>
                            <button data-target="fff-answer" class="show-answer-btn btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show Answer</button>
                        </div>
                    </div>`;
                
                const isLastQuestion = gameState.questionIndex >= roundData.length - 1;

                gameContent.innerHTML = `
                    <div class="text-center mb-6"><h2 class="text-3xl font-bold">Fastest Finger First</h2></div>
                    <div class="space-y-4">${questionHTML}</div>
                     <div class="text-center mt-4">
                        <button id="next-fff-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
                            ${isLastQuestion ? 'Next Scenarios' : 'Next Question'}
                        </button>
                    </div>`;

                document.querySelector('.show-answer-btn').addEventListener('click', (e) => {
                    document.getElementById(e.currentTarget.dataset.target).classList.remove('blur-sm');
                    e.currentTarget.style.display = 'none';
                });

                document.getElementById('next-fff-btn').addEventListener('click', (e) => {
                     if (isLastQuestion) {
                        refreshContent(2, e.currentTarget);
                    } else {
                        gameState.questionIndex++;
                        renderFastestFingerFirst();
                    }
                });
            }

            function renderKPIIdentifier() {
                const roundData = gameState.gameData.kpiIdentifier;
                const kpiListHTML = roundData.kpis.map(kpi => `<li class="kpi-list-item">${kpi}</li>`).join('');

                gameContent.innerHTML = `
                    <div class="text-center">
                        <div class="flex justify-center items-center gap-4 mb-2">
                            <h2 class="text-3xl font-bold">Whatfix Champion Persona</h2>
                        </div>
                        <h3 class="text-4xl font-bold text-yellow-300 mb-4">${roundData.role}</h3>
                        <p class="text-lg text-gray-300 max-w-4xl mx-auto mb-8">${roundData.description}</p>
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <h4 class="text-2xl font-bold">Potential KPIs</h4>
                            <button id="show-kpis-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Show KPIs</button>
                        </div>
                        <ul id="kpi-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center blur-md transition-all">${kpiListHTML}</ul>
                        <div class="text-center mt-4">
                            <button id="next-kpi-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Next Persona</button>
                        </div>
                    </div>`;

                document.getElementById('next-kpi-btn').addEventListener('click', (e) => refreshContent(3, e.currentTarget));
                document.getElementById('show-kpis-btn').addEventListener('click', (e) => {
                    document.getElementById('kpi-list').classList.remove('blur-md');
                    e.currentTarget.style.display = 'none';
                });
            }
            
            function renderModeratorView() {
                const round = gameState.currentRound;
                const data = gameState.gameData;
                let content = '';

                if (round === 1) {
                    const roundData = data.familyFeud;
                    let questionsHTML = roundData.questions.map(item => `
                        <div class="p-4 bg-gray-800 rounded-lg text-left">
                            <p class="font-bold text-lg">${item.q}</p>
                            <p class="text-green-400 mt-1">${item.a}</p>
                        </div>`).join('');
                    content = `<h2 class="text-3xl font-bold text-center mb-4">EMEA Feud (Answers)</h2>
                               <p class="text-lg text-gray-300 mb-6 bg-gray-900 p-4 rounded-lg">${roundData.case}</p>
                               <div class="space-y-4">${questionsHTML}</div>`;
                } else if (round === 2) {
                     const roundData = data.fastestFinger;
                     let questionsHTML = roundData.map(item => `
                        <div class="p-4 bg-gray-800 rounded-lg text-left">
                            <p class="text-lg">${item.scenario}</p>
                            <p class="font-bold text-xl mt-2">${item.question}</p>
                            <p class="text-green-400 text-lg font-bold mt-2">${item.answer}</p>
                        </div>`).join('');
                    content = `<h2 class="text-3xl font-bold text-center mb-6">Fastest Finger First (Answers)</h2>
                               <div class="space-y-4">${questionsHTML}</div>`;
                } else if (round === 3) {
                    const roundData = data.kpiIdentifier;
                    const kpiListHTML = roundData.kpis.map(kpi => `<li class="kpi-list-item">${kpi}</li>`).join('');
                    content = `<div class="text-center">
                                <h2 class="text-3xl font-bold mb-2">Whatfix Champion Persona</h2>
                                <h3 class="text-4xl font-bold text-yellow-300 mb-4">${roundData.role}</h3>
                                <p class="text-lg text-gray-300 max-w-4xl mx-auto mb-8">${roundData.description}</p>
                                <h4 class="text-2xl font-bold mb-4">Potential KPIs</h4>
                                <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center">${kpiListHTML}</ul>
                               </div>`;
                }
                moderatorContent.innerHTML = content;
            }

            function showMessage(message, isError = false) {
                messageArea.textContent = message;
                messageArea.className = isError ? 'text-red-500 my-4 h-6 font-semibold' : 'text-yellow-300 my-4 h-6 font-semibold';
                setTimeout(() => { messageArea.textContent = ''; }, 4000);
            }

            // --- AI CONTENT GENERATION ---
            async function generateGameContent(round) {
                let prompt;
                if (round === 1) {
                    prompt = `You are a sales strategy expert for Whatfix, focusing on the EMEA market. Create a short, one-paragraph case study about a potential enterprise client in the EMEA region facing digital transformation challenges. Based on this case, provide 5 "pure signal" questions a sales rep should ask to uncover pain points, ranked by signal strength. Each question should have a concise, ideal answer. Return ONLY a valid JSON object like this: {"familyFeud": {"case": "...", "questions": [{"q": "...", "a": "..."}]}}`;
                } else if (round === 2) {
                    prompt = `You are an expert in Customer Success and Project Management metrics. Generate 3 'Fastest Finger First' scenarios. For each scenario, randomly pick one of the following topics: Customer Churn Rate, Detractor Score, Customer Lifetime Value (CLV), Monthly Recurring Revenue (MRR), Velocity, Schedule Variance (SV), Net Revenue Retention (NRR), Cycle Time, Time to Value (TTV), Customer Retention Rate, Customer Onboarding Completion Rate, Critical Path, Burndown Rate. Based on the chosen topic, randomly generate either: 1. A 'definition' question asking what the metric is. 2. A 'calculation' scenario with numbers, asking the user to calculate the metric. For each of the 3 scenarios, provide the scenario/question and a detailed answer that explains the formula (if applicable) and shows the calculation. Return ONLY a valid JSON object like this: {"fastestFinger": [{"scenario": "...", "question": "...", "answer": "..."}, ...]}`;
                } else if (round === 3) {
                    prompt = `You are an expert on the value proposition of Whatfix. Identify a key "Whatfix champion or sponsor role" within a potential enterprise client. A sponsor is a leader overlooking the project (e.g., CIO, VP of Sales), while a champion is a hands-on persona involved in implementation (e.g., Product Owner, Sales Operations Manager). Randomly choose to profile either a sponsor or a champion. Provide the role title, a one-paragraph description of their challenges and goals relevant to Whatfix, and a list of 6 potential KPIs Whatfix can improve for them. Return ONLY a valid JSON object like this: {"kpiIdentifier": {"role": "...", "description": "...", "kpis": ["...", "..."]}}`;
                }

                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json" } };
                const apiKey = "AIzaSyABBoGL4O2Equv-1bhG-_9YArhhyv2cBA4"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    console.log("Gemini API Response:", parsedJson);
                    return parsedJson;
                } catch (error) {
                    console.error("AI content generation failed:", error);
                    showMessage("Could not connect to AI. Please check the API key and network.", true);
                    throw error; // Re-throw the error to be caught by the caller
                }
            }
            
            // Initial render of the scoreboard
            renderScoreboard();
        });
    </script>
</body>
</html>
