<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Clash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .game-board {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .answer-card, .kpi-card {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        .answer-card.flipped, .kpi-card.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .scoreboard-team {
            transition: all 0.3s ease;
        }
        .scoreboard-team.active {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.7); /* blue-500 */
        }
        #timer {
            font-weight: 900;
            font-size: 3rem;
        }
        .modal {
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #1f2937; /* bg-gray-800 */
        }
        .team-name-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            width: 120px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Client Clash</h1>
            <p class="text-gray-400 mt-2">The Ultimate Game for CS and PM Professionals</p>
        </header>

        <!-- Main Content -->
        <main id="game-container" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Panel (Game Board) -->
            <div id="game-board" class="lg:col-span-3 game-board p-6 rounded-2xl shadow-2xl">
                <!-- Initial State -->
                <div id="initial-screen" class="text-center flex flex-col items-center justify-center h-full">
                    <h2 class="text-3xl font-bold mb-4">Welcome to Client Clash!</h2>
                    <div id="message-area" class="my-4 h-6 font-semibold"></div>
                    <div id="loading-state" class="hidden my-4">
                        <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-lg text-gray-300">AI is generating your custom game... Please wait.</p>
                    </div>
                    <div id="start-options">
                        <button id="start-game-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">
                            Start New Game
                        </button>
                    </div>
                </div>

                <!-- Game Content (Dynamically populated) -->
                <div id="game-content" class="hidden"></div>
            </div>

            <!-- Right Panel (Scoreboard & Controls) -->
            <aside id="controls-and-scores" class="space-y-6">
                <!-- Scoreboard -->
                <div class="game-board p-6 rounded-2xl shadow-2xl">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                        <h2 class="text-2xl font-bold">Scoreboard</h2>
                        <button id="add-team-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">+</button>
                    </div>
                    <div id="scoreboard" class="space-y-4">
                        <!-- Teams will be dynamically added here -->
                    </div>
                </div>

                <!-- Timer -->
                <div class="game-board p-6 rounded-2xl shadow-2xl text-center">
                    <h2 class="text-2xl font-bold mb-2">Timer</h2>
                    <div id="timer" class="text-6xl text-red-500">60</div>
                </div>

                <!-- Game Controls -->
                <div id="game-controls" class="game-board p-6 rounded-2xl shadow-2xl hidden">
                    <h2 class="text-2xl font-bold mb-4">Controls</h2>
                    <div class="space-y-3">
                         <button id="instructions-btn" class="btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Instructions</button>
                         <button id="next-round-btn" class="btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Next Round</button>
                         <button id="reset-game-btn" class="btn w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg mt-4">Reset Game</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="modal fixed inset-0 w-full h-full flex items-center justify-center hidden">
        <div class="modal-content w-full max-w-3xl p-8 rounded-2xl shadow-2xl border border-gray-700 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-3xl font-bold mb-4 text-center">Game Instructions</h2>
            <div id="instructions-content" class="text-gray-300 space-y-4"></div>
        </div>
    </div>
    
    <!-- Winner Modal -->
    <div id="winner-modal" class="modal fixed inset-0 w-full h-full flex items-center justify-center hidden">
        <div class="modal-content w-full max-w-md p-8 rounded-2xl shadow-2xl border border-yellow-400 text-center">
             <h2 class="text-4xl font-bold mb-4 text-yellow-300">Game Over!</h2>
             <p id="winner-text" class="text-2xl mb-6"></p>
             <button id="play-again-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl">Play Again</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const app = document.getElementById('app');
        const initialScreen = document.getElementById('initial-screen');
        const gameContent = document.getElementById('game-content');
        const startGameBtn = document.getElementById('start-game-btn');
        const loadingState = document.getElementById('loading-state');
        const startOptions = document.getElementById('start-options');
        const messageArea = document.getElementById('message-area');
        const scoreboardContainer = document.getElementById('scoreboard');
        const addTeamBtn = document.getElementById('add-team-btn');
        const timerDisplay = document.getElementById('timer');
        const gameControls = document.getElementById('game-controls');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const instructionsBtn = document.getElementById('instructions-btn');
        const instructionsModal = document.getElementById('instructions-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const instructionsContent = document.getElementById('instructions-content');
        const winnerModal = document.getElementById('winner-modal');
        const winnerText = document.getElementById('winner-text');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- FIREBASE SETUP ---
        const appId = 'client-clash-public'; // A generic public ID
        let db, auth, userId;
        const gameId = 'moderator-session'; // Fixed ID for single-screen use
        let gameUnsubscribe = null;

        // IMPORTANT: Replace this with your own Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            app.innerHTML = `<div class="text-red-500 text-center">Error: Could not connect to the game server. Please check your Firebase configuration.</div>`;
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        // --- GAME STATE ---
        let gameState = {};
        let timerInterval;

        // --- SOUNDS ---
        const sounds = {
            correct: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
            wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination(),
            timerTick: new Tone.MembraneSynth().toDestination(),
            roundEnd: new Tone.MetalSynth({ frequency: 100, envelope: { attack: 0.01, decay: 0.4, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(),
        };

        // --- INSTRUCTIONS TEXT ---
        const INSTRUCTIONS = {
            "1": `<h3 class="text-xl font-bold text-blue-400">Round 1: Family Feud</h3><p>One team tries to guess the most popular answers to a survey question. Answers are ranked and have different point values. The team gets three strikes for wrong answers before the other team has a chance to steal the points.</p>`,
            "2": `<h3 class="text-xl font-bold text-blue-400">Round 2: Rapid Fire</h3><p>Each team gets 60 seconds to answer as many questions as possible. Questions are asked one after another. A correct answer earns 10 points. The timer is relentless!</p>`,
            "3": `<h3 class="text-xl font-bold text-blue-400">Round 3: KPI Identifier</h3><p>A client scenario is presented. Teams must identify the most relevant Key Performance Indicators (KPIs) from a given list. Each correct KPI earns 20 points, but each incorrect selection loses 10 points!</p>`
        };

        // --- EVENT LISTENERS ---
        startGameBtn.addEventListener('click', createNewGame);
        addTeamBtn.addEventListener('click', addTeam);
        resetGameBtn.addEventListener('click', resetGame);
        nextRoundBtn.addEventListener('click', advanceRound);
        instructionsBtn.addEventListener('click', showInstructions);
        closeModalBtn.addEventListener('click', () => instructionsModal.classList.add('hidden'));
        playAgainBtn.addEventListener('click', () => {
            winnerModal.classList.add('hidden');
            resetGame();
        });

        // --- GAME FLOW FUNCTIONS ---
        async function createNewGame() {
            loadingState.classList.remove('hidden');
            startOptions.classList.add('hidden');
            await Tone.start();

            try {
                const gameData = await generateGameContent();
                if (!gameData) throw new Error("AI failed to generate game data.");
                
                const newGameState = {
                    gameData,
                    currentRound: 1,
                    activeTeamIndex: 0,
                    teams: [
                        { name: 'Team 1', score: 0 },
                        { name: 'Team 2', score: 0 }
                    ],
                    roundState: {},
                };

                await setDoc(doc(db, `artifacts/${appId}/public/data/client_clash/${gameId}`), newGameState);
                
                if (!gameUnsubscribe) {
                    attachGameListener();
                }

            } catch (error) {
                console.error("Error creating new game:", error);
                showMessage("Failed to start game. The AI might be busy.", true);
                loadingState.classList.add('hidden');
                startOptions.classList.remove('hidden');
            }
        }

        function attachGameListener() {
            if (gameUnsubscribe) gameUnsubscribe();
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/client_clash/${gameId}`);
            gameUnsubscribe = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    renderGame();
                } else {
                    // Game doc doesn't exist, show initial screen
                    showInitialScreen();
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                showMessage("Connection to game lost. Please refresh.", true);
            });
        }
        
        function showInitialScreen() {
            initialScreen.classList.remove('hidden');
            gameContent.classList.add('hidden');
            gameControls.classList.add('hidden');
            loadingState.classList.add('hidden');
            startOptions.classList.remove('hidden');
            scoreboardContainer.innerHTML = '';
        }

        async function advanceRound() {
            if (gameState.currentRound < 3) {
                await updateFirestore({ currentRound: gameState.currentRound + 1, roundState: {}, activeTeamIndex: 0 });
            } else {
                endGame();
            }
        }

        async function resetGame() {
            showInitialScreen();
            // Optional: clear the firestore doc
            // await setDoc(doc(db, `artifacts/${appId}/public/data/client_clash/${gameId}`), {});
        }
        
        function endGame() {
            const winner = gameState.teams.reduce((prev, current) => (prev.score > current.score) ? prev : current);
            winnerText.textContent = `${winner.name} is the winner!`;
            winnerModal.classList.remove('hidden');
        }

        // --- RENDERING FUNCTIONS ---
        function renderGame() {
            if (!gameState || !gameState.gameData) {
                showInitialScreen();
                return;
            }
            
            initialScreen.classList.add('hidden');
            gameContent.classList.remove('hidden');
            gameControls.classList.remove('hidden');

            renderTeams();
            stopTimer();

            switch (gameState.currentRound) {
                case 1:
                    renderFamilyFeud();
                    nextRoundBtn.textContent = 'Start Rapid Fire Round';
                    break;
                case 2:
                    renderRapidFire();
                    nextRoundBtn.textContent = 'Start KPI Identifier Round';
                    break;
                case 3:
                    renderKPIIdentifier();
                    nextRoundBtn.textContent = 'Finish Game';
                    break;
            }
        }

        function renderTeams() {
            scoreboardContainer.innerHTML = '';
            gameState.teams.forEach((team, index) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'scoreboard-team p-4 bg-gray-700 rounded-lg flex justify-between items-center';
                if (index === gameState.activeTeamIndex) {
                    teamDiv.classList.add('active', 'border-blue-500', 'border-2');
                }

                const teamNameSpan = document.createElement('span');
                teamNameSpan.className = 'font-bold text-lg cursor-pointer';
                teamNameSpan.textContent = team.name;
                
                teamNameSpan.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = team.name;
                    input.className = 'team-name-input font-bold text-lg';
                    teamNameSpan.replaceWith(input);
                    input.focus();

                    const saveName = () => {
                        if (input.value.trim()) {
                            renameTeam(index, input.value.trim());
                        }
                        // No need to replace back, onSnapshot will re-render
                    };
                    
                    input.addEventListener('blur', saveName);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') input.blur();
                    });
                });

                const teamScoreSpan = document.createElement('span');
                teamScoreSpan.className = 'text-2xl font-black text-yellow-300';
                teamScoreSpan.textContent = team.score;

                teamDiv.appendChild(teamNameSpan);
                teamDiv.appendChild(teamScoreSpan);
                scoreboardContainer.appendChild(teamDiv);
            });
        }

        function renderFamilyFeud() {
            const roundData = gameState.gameData.familyFeud[0];
            const roundState = gameState.roundState || { revealed: [], strikes: 0, lastPoints: 0 };

            let answerHTML = roundData.answers.map((ans, index) => {
                const isRevealed = roundState.revealed.includes(index);
                return `
                    <div class="answer-card h-20 flex items-center justify-center rounded-lg cursor-pointer ${isRevealed ? 'flipped' : ''}" data-index="${index}">
                        <div class="card-face w-full h-full bg-blue-900 flex items-center justify-center rounded-lg border-2 border-blue-500"><span class="text-3xl font-bold text-blue-300">${index + 1}</span></div>
                        <div class="card-back w-full h-full bg-gray-700 flex items-center justify-between p-4 rounded-lg"><span class="text-lg font-semibold">${ans.answer}</span><span class="text-2xl font-bold text-yellow-300">${ans.points}</span></div>
                    </div>`;
            }).join('');
            
            let awardButtonsHTML = gameState.teams.map((team, index) => 
                `<button class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" data-team-index="${index}">Award ${team.name}</button>`
            ).join('');

            gameContent.innerHTML = `
                <div class="text-center"><h2 class="text-3xl font-bold mb-6">${roundData.question}</h2></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${answerHTML}</div>
                <div class="flex justify-between items-center mt-8">
                     <div id="award-buttons-container" class="flex flex-wrap gap-2">${awardButtonsHTML}</div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xl font-bold text-red-500">Strikes:</span>
                        <div class="flex space-x-2">${' <div class="w-8 h-8 bg-red-500 rounded-full"></div>'.repeat(roundState.strikes)}${' <div class="w-8 h-8 bg-gray-600 rounded-full"></div>'.repeat(3 - roundState.strikes)}</div>
                        <button id="strike-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Strike</button>
                    </div>
                     <div><button id="switch-team-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg">Switch Active Team</button></div>
                </div>`;
            
            // Event Listeners for Family Feud
            document.querySelectorAll('.answer-card').forEach(card => card.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                const isRevealed = gameState.roundState.revealed?.includes(index);
                if (!isRevealed) {
                    sounds.correct.triggerAttackRelease("C4", "8n");
                    const points = roundData.answers[index].points;
                    const newRevealed = [...(gameState.roundState.revealed || []), index];
                    updateFirestore({ roundState: { ...gameState.roundState, revealed: newRevealed, lastPoints: points } });
                }
            }));
            
            document.getElementById('strike-btn').addEventListener('click', () => {
                const currentStrikes = gameState.roundState.strikes || 0;
                if (currentStrikes < 3) {
                    sounds.wrong.triggerAttackRelease("C3", "8n");
                    updateFirestore({ roundState: { ...gameState.roundState, strikes: currentStrikes + 1 } });
                    if (currentStrikes + 1 >= 3) switchActiveTeam();
                }
            });

            document.getElementById('switch-team-btn').addEventListener('click', switchActiveTeam);
            
            document.querySelectorAll('#award-buttons-container button').forEach(btn => btn.addEventListener('click', (e) => {
                const teamIndex = parseInt(e.currentTarget.dataset.teamIndex);
                const pointsToAward = gameState.roundState.lastPoints || 0;
                if (pointsToAward > 0) {
                    awardPoints(teamIndex, pointsToAward);
                    updateFirestore({ roundState: { ...gameState.roundState, lastPoints: 0 } });
                }
            }));
        }
        
        function renderRapidFire() {
            const activeTeam = gameState.teams[gameState.activeTeamIndex];
            if (!activeTeam) return;

            const roundState = gameState.roundState || { questionIndex: 0 };
            const questions = gameState.gameData.rapidFire;
            const currentQuestion = questions[roundState.questionIndex];

            if (!currentQuestion) {
                gameContent.innerHTML = `<h2 class="text-3xl font-bold text-center">Rapid Fire Round Over for ${activeTeam.name}!</h2><p class="text-center mt-4">Switch teams or proceed to the next round.</p>`;
                stopTimer();
                return;
            }

            gameContent.innerHTML = `
                <div class="text-center flex flex-col items-center justify-center h-full">
                    <p class="text-xl text-gray-400 mb-2">${activeTeam.name}'s Turn</p>
                    <h2 class="text-4xl font-bold mb-8">${currentQuestion.question}</h2>
                    <div class="mt-8 flex space-x-4">
                        <button id="start-timer-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Start Timer</button>
                        <button id="correct-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Correct</button>
                        <button id="pass-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg text-lg">Pass / Incorrect</button>
                        <button id="switch-team-rf-btn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Switch Team</button>
                    </div>
                </div>`;
            
            document.getElementById('start-timer-btn').addEventListener('click', () => startTimer(60, () => {
                sounds.roundEnd.triggerAttackRelease("C2", "2n");
                switchActiveTeam();
                updateFirestore({ roundState: { questionIndex: 0 }});
            }));
            document.getElementById('correct-btn').addEventListener('click', () => {
                sounds.correct.triggerAttackRelease("C5", "8n");
                awardPoints(gameState.activeTeamIndex, 10);
                nextRapidFireQuestion();
            });
            document.getElementById('pass-btn').addEventListener('click', () => {
                 sounds.wrong.triggerAttackRelease("A2", "8n");
                nextRapidFireQuestion();
            });
            document.getElementById('switch-team-rf-btn').addEventListener('click', () => {
                stopTimer();
                switchActiveTeam();
                updateFirestore({ roundState: { questionIndex: 0 }});
            });
        }
        
        function nextRapidFireQuestion() {
            const newIndex = (gameState.roundState.questionIndex || 0) + 1;
            updateFirestore({ roundState: { ...gameState.roundState, questionIndex: newIndex }});
        }

        function renderKPIIdentifier() {
            const activeTeam = gameState.teams[gameState.activeTeamIndex];
            if (!activeTeam) return;

            const roundData = gameState.gameData.kpiIdentifier[0];
            const roundState = gameState.roundState || { selected: [] };

            let kpiHTML = roundData.kpis.map((kpi, index) => {
                const isSelected = roundState.selected.includes(index);
                return `<div class="kpi-card p-4 rounded-lg cursor-pointer border-2 ${isSelected ? 'bg-blue-600 border-blue-400' : 'bg-gray-700 border-gray-600 hover:border-blue-500'}" data-index="${index}"><p class="text-lg font-semibold">${kpi.kpi}</p></div>`;
            }).join('');

            gameContent.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-2">Client Scenario:</h2>
                    <p class="text-lg text-gray-300 mb-6 max-w-3xl mx-auto">${roundData.scenario}</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">${kpiHTML}</div>
                <div class="text-center mt-8"><button id="submit-kpis-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl">Submit KPIs for ${activeTeam.name}</button></div>`;

            document.querySelectorAll('.kpi-card').forEach(card => card.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                const currentSelected = roundState.selected || [];
                const newSelected = currentSelected.includes(index) ? currentSelected.filter(i => i !== index) : [...currentSelected, index];
                updateFirestore({ roundState: { ...gameState.roundState, selected: newSelected } });
            }));
            
            document.getElementById('submit-kpis-btn').addEventListener('click', () => {
                let scoreChange = 0;
                const selectedIndexes = roundState.selected || [];
                const correctIndexes = roundData.kpis.map((kpi, i) => kpi.relevant ? i : -1).filter(i => i !== -1);
                
                selectedIndexes.forEach(selectedIndex => {
                    scoreChange += correctIndexes.includes(selectedIndex) ? 20 : -10;
                });
                
                awardPoints(gameState.activeTeamIndex, scoreChange);
                switchActiveTeam();
                updateFirestore({ roundState: { selected: [] } }); // Reset for next team
            });
        }

        // --- HELPER & UTILITY FUNCTIONS ---
        async function addTeam() {
            const newTeams = [...gameState.teams, { name: `Team ${gameState.teams.length + 1}`, score: 0 }];
            await updateFirestore({ teams: newTeams });
        }

        async function renameTeam(index, newName) {
            const newTeams = [...gameState.teams];
            newTeams[index].name = newName;
            await updateFirestore({ teams: newTeams });
        }
        
        async function awardPoints(teamIndex, points) {
            const newTeams = [...gameState.teams];
            newTeams[teamIndex].score += points;
            await updateFirestore({ teams: newTeams });
        }
        
        function switchActiveTeam() {
            const newIndex = (gameState.activeTeamIndex + 1) % gameState.teams.length;
            updateFirestore({ activeTeamIndex: newIndex });
        }

        function startTimer(duration, onEnd) {
            stopTimer();
            let timeLeft = duration;
            timerDisplay.textContent = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 10 && timeLeft > 0) {
                    sounds.timerTick.triggerAttackRelease("C2", "8n", Tone.now());
                    timerDisplay.classList.add('animate-ping');
                } else {
                     timerDisplay.classList.remove('animate-ping');
                }
                if (timeLeft <= 0) {
                    stopTimer();
                    if (onEnd) onEnd();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplay.textContent = '60';
            timerDisplay.classList.remove('animate-ping');
        }

        function showInstructions() {
            instructionsContent.innerHTML = INSTRUCTIONS[gameState.currentRound];
            instructionsModal.classList.remove('hidden');
        }

        function showMessage(message, isError = false) {
            messageArea.textContent = message;
            messageArea.className = isError ? 'text-red-500 my-4 h-6 font-semibold' : 'text-yellow-300 my-4 h-6 font-semibold';
            setTimeout(() => { messageArea.textContent = ''; }, 4000);
        }

        async function updateFirestore(data) {
            const gameRef = doc(db, `artifacts/${appId}/public/data/client_clash/${gameId}`);
            await updateDoc(gameRef, data);
        }

        // --- AI CONTENT GENERATION ---
        async function generateGameContent() {
            const prompt = `
                Create a team-building game called 'Client Clash' for Customer Success Managers and Project Managers.
                Generate content for three rounds: Family Feud, Rapid Fire, and KPI Identifier.
                The tone should be professional but fun. Questions should be relevant to client management, project lifecycles, common acronyms, and business metrics.

                Return the output ONLY as a valid JSON object with the following structure:
                {
                  "familyFeud": [ { "question": "Name a common reason for project scope creep.", "answers": [ { "answer": "Unclear initial requirements", "points": 45 }, { "answer": "Client requests 'small' changes", "points": 30 }, { "answer": "Lack of a formal change control process", "points": 15 }, { "answer": "Poor communication", "points": 10 } ] } ],
                  "rapidFire": [ { "question": "What does 'ARR' stand for in a SaaS business?", "answer": "Annual Recurring Revenue" }, { "question": "Name a popular project management software.", "answer": "Jira, Asana, or Trello" }, { "question": "What is a 'Gantt Chart' used for?", "answer": "Visualizing a project schedule" }, { "question": "What does 'QBR' stand for?", "answer": "Quarterly Business Review" } ],
                  "kpiIdentifier": [ { "scenario": "A B2B SaaS client has a low product adoption rate for a new feature launched 3 months ago. Their goal is to increase user engagement and demonstrate ROI to their leadership.", "kpis": [ { "kpi": "Feature Adoption Rate", "relevant": true }, { "kpi": "Monthly Active Users (MAU)", "relevant": true }, { "kpi": "Customer Satisfaction Score (CSAT)", "relevant": true }, { "kpi": "Employee Turnover Rate", "relevant": false } ] } ]
                }`;
            
            // This is a placeholder for the Gemini API call.
            // In a real environment, you would make a fetch request here.
            // For GitHub Pages, we will use fallback data.
            console.log("Using fallback data for AI content generation.");
            return {"familyFeud":[{"question":"Name a common client 'red flag' during onboarding.","answers":[{"answer":"'We don't have a dedicated point of contact'","points":40},{"answer":"'Can we start before the contract is signed?'","points":30},{"answer":"'This should be really simple and quick'","points":20},{"answer":"Constantly changing requirements","points":10}]}],"rapidFire":[{"question":"What does 'CRM' stand for?","answer":"Customer Relationship Management"},{"question":"What is a project 'milestone'?","answer":"A specific point in a project's timeline"}],"kpiIdentifier":[{"scenario":"A client's support ticket volume has increased by 50% in the last month, and their CSAT scores are dropping.","kpis":[{"kpi":"First Response Time (FRT)","relevant":true},{"kpi":"Ticket Resolution Time","relevant":true},{"kpi":"Website Bounce Rate","relevant":false}]}]};
        }
        
        // Initial listener attachment
        attachGameListener();

    </script>
</body>
</html>
